<section class="py-8 bg-gray-50 dark:bg-gray-900 animate__animated animate__fadeIn min-h-screen">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Header with New Invite button -->
        <div class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-3xl font-bold text-gray-900 dark:text-white">{{ _("Dashboard") }}</h1>
            </div>
            <button 
                id="newInviteBtn"
                class="bg-primary hover:bg-primary_hover text-white font-medium px-6 py-3 rounded-lg shadow-lg transition-all duration-200 flex items-center gap-2"
                onclick="openInviteModal()"
            >
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                </svg>
                {{ _("New Invite") }}
            </button>
        </div>

        <!-- Dashboard grid -->
        <div class="dashboard-grid grid grid-cols-1 lg:grid-cols-3 grid-rows-2 gap-8">

            <!-- Now Playing Section (top row, spans full width) -->
            <div class="col-span-1 lg:col-span-3 h-[40vh] flex flex-col relative z-20">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-semibold text-gray-900 dark:text-white flex items-center gap-2">
                        <svg class="w-6 h-6 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h1m4 0h1m-6 4h8m2-10v12a2 2 0 01-2 2H6a2 2 0 01-2-2V6a2 2 0 012-2h8l4 4z"></path>
                        </svg>
                        {{ _("Now Playing") }}
                    </h2>
                    <div class="flex items-center gap-2 text-sm text-gray-500 dark:text-gray-400">
                        <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                        <span>{{ _("Live") }}</span>
                    </div>
                </div>

                <!-- Now Playing Cards Container -->
                <div id="nowPlayingContainer" 
                     class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 2xl:grid-cols-6 gap-4 flex-1 overflow-y-auto auto-rows-max"
                     hx-get="/now-playing-cards"
                     hx-trigger="load, every 10s"
                     hx-swap="innerHTML">
                    <!-- Loading placeholder -->
                    <div class="col-span-full flex justify-center items-center py-12">
                        <div class="text-center">
                            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto mb-4"></div>
                            <p class="text-gray-500 dark:text-gray-400">{{ _("Loading now playing...") }}</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Latest Accepted Invites Card (bottom-left) -->
            <div class="col-span-1">
                <div id="latestInvitesContainer"
                     class="animate__animated animate__fadeIn h-full"
                     hx-get="/accepted-invites-card"
                     hx-trigger="load, every 30s"
                     hx-swap="innerHTML">
                    <!-- Loading placeholder -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-4 h-full flex flex-col justify-center items-center">
                        <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-primary mb-2"></div>
                        <p class="text-center text-sm text-gray-500 dark:text-gray-400">{{ _("Loading invites…") }}</p>
                    </div>
                </div>
            </div>

            <!-- Placeholder for future widgets (bottom-right) -->
            <div class="col-span-1 hidden lg:block"></div>
        </div>

    <!-- Invite Modal -->
    <div id="inviteModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center p-6 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">{{ _("Create New Invite") }}</h3>
                <button 
                    onclick="closeInviteModal()"
                    class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300"
                >
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div id="inviteModalContent" class="p-6">
                <!-- Invite form will be loaded here -->
                <div class="flex justify-center items-center py-8">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
// Modal functions
function openInviteModal() {
    const modal = document.getElementById('inviteModal');
    modal.classList.remove('hidden');
    
    // Load invite form
    htmx.ajax('GET', '/invite', {
        target: '#inviteModalContent',
        swap: 'innerHTML'
    });
}

function closeInviteModal() {
    const modal = document.getElementById('inviteModal');
    modal.classList.add('hidden');
}

// Close modal on escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeInviteModal();
    }
});

// Close modal on backdrop click
document.getElementById('inviteModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeInviteModal();
    }
});

// Live timer updates for now playing sessions
let liveTimerInterval = null;

function startLiveTimer() {
    // Clear any existing interval
    if (liveTimerInterval) {
        clearInterval(liveTimerInterval);
    }
    
    liveTimerInterval = setInterval(updateLiveTimers, 1000);
}

function updateLiveTimers() {
    const sessions = document.querySelectorAll('[data-session-id]');
    
    sessions.forEach(session => {
        const state = session.getAttribute('data-session-state');
        const duration = parseInt(session.getAttribute('data-session-duration') || '0');
        let position = parseInt(session.getAttribute('data-session-position') || '0');
        
        // Only update if playing
        if (state === 'playing' && duration > 0) {
            // Increment position by 1 second (1000ms)
            position += 1000;
            
            // Don't exceed duration
            if (position > duration) {
                position = duration;
            }
            
            // Update stored position
            session.setAttribute('data-session-position', position.toString());
            
            // Calculate new progress
            const progress = position / duration;
            const progressPercent = Math.round(progress * 100);
            
            // Update progress bar
            const progressBar = session.querySelector('.progress-bar');
            if (progressBar) {
                progressBar.style.width = progressPercent + '%';
            }
            
            // Update time display
            const timeDisplay = session.querySelector('.time-position');
            if (timeDisplay) {
                const posSeconds = Math.floor(position / 1000);
                const posMins = Math.floor(posSeconds / 60);
                const posSecsRemainder = posSeconds % 60;
                timeDisplay.textContent = `${posMins}:${posSecsRemainder.toString().padStart(2, '0')}`;
            }
        }
    });
}

// Re-init Flowbite popovers when HTMX swaps in new now-playing cards
function reinitFlowbitePopovers() {
    if (typeof initFlowbite === 'function') {
        initFlowbite(); // official helper (ES module / CDN helper)
    } else if (window.Flowbite && typeof window.Flowbite.init === 'function') {
        window.Flowbite.init();
    } else {
        // Fallback – manually attach hover listeners for data-popover-target
        document.querySelectorAll('[data-popover-target]').forEach(trigger => {
            if (trigger.dataset.popoverBound) return; // skip if already bound
            const targetId = trigger.getAttribute('data-popover-target');
            const pop = document.getElementById(targetId);
            if (!pop) return;
            // ensure arrow orientation for bottom placement
            pop.setAttribute('data-popper-placement', 'bottom');
            const show = () => {
                pop.classList.remove('invisible', 'opacity-0');
            };
            const hide = () => {
                pop.classList.add('opacity-0');
                setTimeout(() => pop.classList.add('invisible'), 300);
            };
            trigger.addEventListener('mouseenter', show);
            trigger.addEventListener('mouseleave', hide);
            pop.addEventListener('mouseenter', show);
            pop.addEventListener('mouseleave', hide);
            trigger.dataset.popoverBound = 'true';
        });
    }
}

document.addEventListener('htmx:afterSwap', function(evt) {
    if (evt.target && evt.target.id === 'nowPlayingContainer') {
        reinitFlowbitePopovers();
        // Restart live-timer so newly swapped cards animate correctly
        startLiveTimer();
    }
});

document.addEventListener('DOMContentLoaded', reinitFlowbitePopovers);
// Start timer on initial page load
document.addEventListener('DOMContentLoaded', function() {
    startLiveTimer();
});
</script>

<style>
.line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

/* Blobby hover animation for session cards */
.session-card {
    transform-origin: center top;
    transition: all 0.3s ease; /* simpler transition */
    overflow: visible;
}

.session-card:hover {
    position: relative;
    z-index: 50;
    /* remove scaling/shadow animation */
}

/* Remove sibling shrink effect */
.session-card:hover ~ .session-card {
    transform: none;
    opacity: 1;
}

/* Hover overlay animation */
.hover-overlay {
    backdrop-filter: blur(8px);
    border-radius: 0.5rem;
    transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
}

/* Ensure cards don't interfere with each other during hover */
.session-card:hover ~ .session-card {
    transform: none;
    opacity: 1;
}

/* Grid container adjustments for hover effects */
#nowPlayingContainer {
    perspective: 1000px;
    overflow: visible; /* Allow cards to overflow outside grid */
}

/* Smooth transitions for grid items */
#nowPlayingContainer > div {
    transition: all 0.3s ease;
    overflow: visible;
}

/* Additional hover effects for better UX */
.session-card:hover .hover-overlay {
    animation: slideInUp 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
}

@keyframes slideInUp {
    from {
        opacity: 0;
        transform: translateY(20px) scale(0.95);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}
</style> 