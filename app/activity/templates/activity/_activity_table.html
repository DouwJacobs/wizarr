{% if error %}
    <div class="text-center py-12">
        <div class="text-red-500 dark:text-red-400">
            <svg class="w-16 h-16 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            <h3 class="text-lg font-medium mb-2">{{ _("Unable to load activity data") }}</h3>
            <p>{{ error }}</p>
        </div>
    </div>
{% elif not sessions %}
    <div class="text-center py-12">
        <div class="text-gray-500 dark:text-gray-400">
            <svg class="w-16 h-16 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
            </svg>
            <h3 class="text-lg font-medium mb-2">{{ _("No activity found") }}</h3>
            <p>{{ _("No media sessions found for the selected period") }}</p>
        </div>
    </div>
{% else %}
    <!-- Activity Table -->
    <div class="relative overflow-x-auto">
        <table class="w-full text-sm text-left rtl:text-right text-gray-500 dark:text-gray-400">
            <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
                <tr>
                    <th scope="col" class="px-6 py-3">
                        {{ _("User") }}
                    </th>
                    <th scope="col" class="px-6 py-3">
                        {{ _("Server") }}
                    </th>
                    <th scope="col" class="px-6 py-3">
                        {{ _("Media") }}
                    </th>
                    <th scope="col" class="px-6 py-3">
                        {{ _("Device") }}
                    </th>
                    <th scope="col" class="px-6 py-3">
                        {{ _("Duration") }}
                    </th>
                    <th scope="col" class="px-6 py-3">
                        {{ _("Started") }}
                    </th>
                </tr>
            </thead>
            <tbody>
                {% for session in sessions %}
                    {% set duration_seconds = session.display_duration_seconds %}
                    {% set duration_str = "" %}
                    {% if duration_seconds %}
                        {% set total_minutes = (duration_seconds // 60) | int %}
                        {% set hours = (total_minutes // 60) | int %}
                        {% set minutes = (total_minutes % 60) | int %}
                        {% if hours > 0 %}
                            {% set duration_str = "{}h {}m".format(hours, minutes) %}
                        {% else %}
                            {% set duration_str = "{}m".format(minutes) %}
                        {% endif %}
                    {% endif %}

                    <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">
                        <!-- User -->
                        <td class="px-6 py-4">
                            <div class="flex items-center">
                                <svg class="w-4 h-4 mr-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                                </svg>
                                <span class="text-sm text-gray-900 dark:text-white">{{ session.display_user_name }}</span>
                            </div>
                        </td>

                        <!-- Server -->
                        <td class="px-6 py-4">
                            {% if session.server_type and session.server_name %}
                                {{ session.server_type|server_name_tag(session.server_name) }}
                            {% else %}
                                <span class="text-sm text-gray-400">{{ _("Unknown") }}</span>
                            {% endif %}
                        </td>

                        <!-- Media -->
                        <td class="px-6 py-4">
                            <div class="flex items-center">
                                <div class="flex-1 min-w-0">
                                    <div class="text-sm font-medium text-gray-900 dark:text-white truncate max-w-xs" title="{{ session.media_title }}">
                                        {{ session.media_title }}
                                    </div>
                                    {% if session.series_name %}
                                        <div class="text-xs text-gray-600 dark:text-gray-300 truncate">
                                            {{ session.series_name }}
                                            {% if session.season_number and session.episode_number %}
                                                â€¢ S{{ session.season_number }}E{{ session.episode_number }}
                                            {% endif %}
                                        </div>
                                    {% endif %}
                                    {% if session.media_type %}
                                        <span class="inline-flex items-center mt-1 px-2.5 py-0.5 rounded-full border border-blue-200 bg-blue-100 text-xs font-semibold text-blue-800 shadow-sm dark:border-blue-400/60 dark:bg-blue-500/25 dark:text-blue-100 capitalize">
                                            {{ session.media_type }}
                                        </span>
                                    {% endif %}
                                </div>
                            </div>
                        </td>

                        <!-- Device -->
                        <td class="px-6 py-4">
                            <div class="flex items-center">
                                <svg class="w-4 h-4 mr-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                                </svg>
                                <span class="text-sm text-gray-600 dark:text-gray-300">{{ session.device_name or session.client_name or _("Unknown Device") }}</span>
                            </div>
                        </td>

                        <!-- Status -->
                        <!-- Duration -->
                        <td class="px-6 py-4">
                            {% if session.is_active and session.started_at %}
                                <div class="live-timer font-medium text-green-600 dark:text-green-400"
                                     data-start-time="{{ session.started_at.isoformat() }}"
                                     data-session-id="{{ session.id }}">
                                    <span class="timer-display">00:00</span>
                                    <div class="text-xs text-gray-500 dark:text-gray-400">{{ _("Live") }}</div>
                                </div>
                            {% elif duration_str %}
                                <div class="text-sm text-gray-900 dark:text-white">
                                    {{ duration_str }}
                                </div>
                            {% else %}
                                <div class="text-sm text-gray-400">{{ _("N/A") }}</div>
                            {% endif %}
                        </td>

                        <!-- Started -->
                        <td class="px-6 py-4">
                            <div class="text-sm text-gray-900 dark:text-white">
                                {{ session.started_at|local_date if session.started_at else '-' }}
                            </div>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    {% if total_pages > 1 %}
    <div class="flex flex-col items-center mt-6 mb-6">
        <!-- Help text -->
        <span class="text-sm text-gray-700 dark:text-gray-400 mb-2">
            {{ _("Showing") }} <span class="font-semibold text-gray-900 dark:text-white">{{ ((page - 1) * 20) + 1 }}</span>
            {{ _("to") }} <span class="font-semibold text-gray-900 dark:text-white">{{ ((page - 1) * 20) + sessions|length }}</span>
            {{ _("of") }} <span class="font-semibold text-gray-900 dark:text-white">{{ total_count }}</span> {{ _("entries") }}
        </span>

        <!-- Numbered Pagination -->
        {% from '_partials/macros.html' import numbered_pagination %}
        {{ numbered_pagination(page, total_pages) }}
    </div>
    {% endif %}
{% endif %}

<script>
function paginateTo(page) {
    // Build query parameters from current URL but replace page number
    const params = new URLSearchParams(window.location.search);
    params.set('page', page);

    // Remove days parameter since history shows all data
    params.delete('days');

    // Make the HTMX request
    htmx.ajax('GET', '{{ url_for("activity.activity_grid") }}?' + params.toString(), {
        target: '#activity-table-container'
    });
}
</script>

<script>
// Live timer functionality
function updateLiveTimers() {
    const timers = document.querySelectorAll('.live-timer');
    const now = new Date();

    timers.forEach(timer => {
        // Ensure start time is treated as UTC
        const startTimeStr = timer.dataset.startTime;
        const startTime = new Date(startTimeStr.endsWith('Z') ? startTimeStr : startTimeStr + 'Z');
        const elapsed = Math.floor((now - startTime) / 1000); // seconds

        // Calculate hours, minutes, seconds
        const hours = Math.floor(elapsed / 3600);
        const minutes = Math.floor((elapsed % 3600) / 60);
        const seconds = elapsed % 60;

        // Format display
        let display = '';
        if (hours > 0) {
            display = `${hours}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        } else {
            display = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        const displayElement = timer.querySelector('.timer-display');
        if (displayElement) {
            displayElement.textContent = display;
        }
    });
}

// Start timer immediately since this script runs after HTMX loads the content
(function() {
    // Update timers immediately
    updateLiveTimers();

    // Then update every second
    setInterval(updateLiveTimers, 1000);
})();

// Also update timers when new content is loaded via HTMX
document.addEventListener('htmx:afterSwap', function() {
    updateLiveTimers();
});

function viewSessionDetails(sessionId) {
    // Fetch and display session details in a modal
    fetch(`{{ url_for('activity.activity_session', session_id=0) }}`.replace('0', sessionId))
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert(data.error);
                return;
            }

            // Create modal content
            const modalContent = `
                <div class="space-y-4">
                    <div>
                        <h3 class="text-lg font-medium text-gray-900 dark:text-white">${data.media_title}</h3>
                        ${data.series_name ? `<p class="text-sm text-gray-500 dark:text-gray-400">${data.series_name} - S${data.season_number}E${data.episode_number}</p>` : ''}
                    </div>

                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div>
                            <strong class="text-gray-900 dark:text-white">{{ _("User") }}:</strong>
                            <span class="text-gray-600 dark:text-gray-300">${data.display_user_name}</span>
                        </div>
                        <div>
                            <strong class="text-gray-900 dark:text-white">{{ _("Device") }}:</strong>
                            <span class="text-gray-600 dark:text-gray-300">${data.device_name || data.client_name || '{{ _("Unknown") }}'}</span>
                        </div>
                        <div>
                            <strong class="text-gray-900 dark:text-white">{{ _("Started") }}:</strong>
                            <span class="text-gray-600 dark:text-gray-300">${new Date(data.started_at).toLocaleString()}</span>
                        </div>
                    </div>

                    ${data.transcoding_info && Object.keys(data.transcoding_info).length > 0 ? `
                        <div>
                            <strong class="text-gray-900 dark:text-white block mb-2">{{ _("Transcoding Info") }}:</strong>
                            <div class="bg-gray-50 dark:bg-gray-700 rounded p-3 text-sm">
                                <pre class="whitespace-pre-wrap">${JSON.stringify(data.transcoding_info, null, 2)}</pre>
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;

            // Show modal (you'll need to implement this based on your modal system)
            showSessionModal(modalContent);
        })
        .catch(error => {
            console.error('Error fetching session details:', error);
            alert('{{ _("Failed to load session details") }}');
        });
}

function showSessionModal(content) {
    // Simple modal implementation - you can enhance this
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50';
    modal.innerHTML = `
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-screen overflow-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-gray-900 dark:text-white">{{ _("Session Details") }}</h2>
                    <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
                ${content}
            </div>
        </div>
    `;

    document.body.appendChild(modal);

    // Close on background click
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            modal.remove();
        }
    });
}
</script>
